<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Football Predictions</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 900px;
    }
    .card {
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s ease-in-out;
    }
    .card:hover {
      transform: translateY(-3px);
    }
    .admin-link {
      text-align: right;
      margin-top: 20px;
    }
    #countdown {
      font-size: 1.1rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container py-5">
  <div class="text-end mb-2">
    <a href="https://odibets.com/league" target="_blank">
      <img src="https://odibets.com/assets/images/odibets_logo.png" alt="OdiBets" style="height: 50px;">
    </a>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Football Predictions</h2>
    <a href="bett.html" class="btn btn-outline-primary">üîê</a>
  </div>

    <div id="statusMsg" class="text-center text-muted mb-3">Checking subscription...</div>
    <div id="countdown" class="text-center mb-4 text-success"></div>

    <div id="predictions" class="row g-4"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBTmeDxIUhua52KDAoag23q9MuNEOQXYQg",
      authDomain: "prediction-94bf9.firebaseapp.com",
      projectId: "prediction-94bf9",
      storageBucket: "prediction-94bf9.appspot.com",
      messagingSenderId: "960123689722",
      appId: "1:960123689722:web:c707337a7b6972a3478743"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const email = localStorage.getItem("subscribedEmail");
    const statusMsg = document.getElementById("statusMsg");
    const countdownEl = document.getElementById("countdown");
    const predictionsEl = document.getElementById("predictions");
    let expiryTime = null;

    function formatCountdown(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}m ${seconds}s`;
    }

    function startCountdown() {
      const interval = setInterval(() => {
        const now = Date.now();
        const remaining = expiryTime - now;

        if (remaining <= 0) {
          clearInterval(interval);
          countdownEl.innerHTML = "Access expired.";
          statusMsg.innerHTML = "<span class='text-danger'>Redirecting to subscribe...</span>";
          localStorage.removeItem("subscribedEmail");
          setTimeout(() => window.location.href = "index.html", 3000);
        } else {
          countdownEl.innerText = `Access ends in: ${formatCountdown(remaining)}`;
        }
      }, 1000);
    }

    function loadPredictions() {
      db.collection("predictions").orderBy("timestamp", "desc").get().then(snapshot => {
        predictionsEl.innerHTML = "";
        snapshot.forEach(doc => {
          const p = doc.data();
          const card = document.createElement("div");
          card.className = "col-md-6";
          card.innerHTML = `
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">${p.home} vs ${p.away}</h5>
                <p class="card-text">
                  <strong>Time:</strong> ${p.time}<br>
                  <strong>Prediction:</strong> ${p.prediction}<br>
                  <strong>Result:</strong> ${
                    p.result === "correct" ? "‚úîÔ∏è" : 
                    p.result === "wrong" ? "‚úñÔ∏è" : "Pending"
                  }
                </p>
              </div>
            </div>
          `;
          predictionsEl.appendChild(card);
        });
      });
    }

    function checkSubscription() {
      if (!email) {
        statusMsg.innerHTML = "<span class='text-danger'>No email found. Redirecting...</span>";
        setTimeout(() => window.location.href = "subscribe.html", 2000);
        return;
      }

      db.collection("verifications")
        .where("email", "==", email)
        .orderBy("submittedAt", "desc")
        .limit(1)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            statusMsg.innerHTML = "<span class='text-danger'>No subscription found.</span>";
            setTimeout(() => window.location.href = "subscribe.html", 2000);
            return;
          }

          const data = snapshot.docs[0].data();
          const now = Date.now();

          if (data.verified && data.expiry && now < data.expiry) {
            expiryTime = data.expiry;
            statusMsg.innerHTML = `<span class='text-success'>Access valid until ${new Date(expiryTime).toLocaleTimeString()}</span>`;
            loadPredictions();
            startCountdown();
          } else {
            statusMsg.innerHTML = "<span class='text-warning'>Subscription expired. Redirecting...</span>";
            localStorage.removeItem("subscribedEmail");
            setTimeout(() => window.location.href = "subscribe.html", 2000);
          }
        });
    }

    document.addEventListener("DOMContentLoaded", checkSubscription);
  </script>
</body>
</html>
